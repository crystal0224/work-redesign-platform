// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User and Team Models
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  role        UserRole @default(TEAM_MEMBER)
  department  String?
  position    String?
  avatarUrl   String?
  preferences Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teamMemberships    TeamMember[]
  ledTeams           Team[]               @relation("TeamLeader")
  createdProjects    Project[]            @relation("ProjectCreator")
  assignedTasks      Task[]               @relation("TaskAssignee")
  createdTasks       Task[]               @relation("TaskCreator")
  createdSessions    WorkshopSession[]    @relation("SessionCreator")
  participantSessions WorkshopSession[]   @relation("SessionParticipants")
  aiAnalysisRequests AiAnalysis[]         @relation("AnalysisRequester")
  comments           Comment[]
  fileUploads        FileUpload[]
  activityLogs       ActivityLog[]

  @@map("users")
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  leaderId    String
  department  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  leader  User         @relation("TeamLeader", fields: [leaderId], references: [id])
  members TeamMember[]
  projects Project[]

  @@map("teams")
}

model TeamMember {
  id       String           @id @default(cuid())
  teamId   String
  userId   String
  role     TeamMemberRole   @default(MEMBER)
  joinedAt DateTime         @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

// Workshop Session Models
model WorkshopSession {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      SessionStatus @default(PLANNING)
  progress    Int           @default(0)
  duration    Int           @default(35) // Duration in minutes
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  // Relations
  creator      User           @relation("SessionCreator", fields: [createdBy], references: [id])
  participants User[]         @relation("SessionParticipants")
  domains      Domain[]
  fileUploads  FileUpload[]
  projects     Project[]
  aiAnalyses   AiAnalysis[]
  activityLogs ActivityLog[]

  @@map("workshop_sessions")
}

model Domain {
  id          String   @id @default(cuid())
  sessionId   String
  name        String
  description String?
  position    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  session WorkshopSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@map("domains")
}

// Project and Task Models
model Project {
  id          String        @id @default(cuid())
  title       String
  description String?
  teamId      String?
  sessionId   String?
  status      ProjectStatus @default(PLANNING)
  priority    Priority      @default(MEDIUM)
  startDate   DateTime?
  dueDate     DateTime?
  progress    Int           @default(0)
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  team           Team?             @relation(fields: [teamId], references: [id])
  session        WorkshopSession?  @relation(fields: [sessionId], references: [id])
  creator        User              @relation("ProjectCreator", fields: [createdBy], references: [id])
  tasks          Task[]
  kanbanBoards   KanbanBoard[]
  aiAnalyses     AiAnalysis[]
  recommendations AiRecommendation[]

  @@map("projects")
}

model Task {
  id             String     @id @default(cuid())
  projectId      String?
  domainId       String?
  title          String
  description    String?
  assigneeId     String?
  status         TaskStatus @default(BACKLOG)
  priority       Priority   @default(MEDIUM)
  estimatedHours Int?
  actualHours    Int        @default(0)
  dueDate        DateTime?
  position       Int
  labels         Json       @default("[]")
  createdBy      String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  project      Project?          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  domain       Domain?           @relation(fields: [domainId], references: [id])
  assignee     User?             @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator      User              @relation("TaskCreator", fields: [createdBy], references: [id])
  dependencies TaskDependency[]  @relation("DependentTask")
  prerequisites TaskDependency[] @relation("PrerequisiteTask")
  kanbanCards  KanbanCard[]
  comments     Comment[]
  fileUploads  FileUpload[]

  @@map("tasks")
}

model TaskDependency {
  id                   String   @id @default(cuid())
  dependentTaskId      String
  prerequisiteTaskId   String
  createdAt            DateTime @default(now())

  // Relations
  dependentTask    Task @relation("DependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)
  prerequisiteTask Task @relation("PrerequisiteTask", fields: [prerequisiteTaskId], references: [id], onDelete: Cascade)

  @@unique([dependentTaskId, prerequisiteTaskId])
  @@map("task_dependencies")
}

// Kanban Board Models
model KanbanBoard {
  id        String   @id @default(cuid())
  projectId String
  name      String   @default("Main Board")
  columns   Json     @default("[{\"id\": \"backlog\", \"name\": \"백로그\", \"color\": \"#f5f5f5\", \"position\": 0}, {\"id\": \"in_progress\", \"name\": \"진행중\", \"color\": \"#e6f7ff\", \"position\": 1}, {\"id\": \"review\", \"name\": \"검토\", \"color\": \"#fff7e6\", \"position\": 2}, {\"id\": \"completed\", \"name\": \"완료\", \"color\": \"#f6ffed\", \"position\": 3}]")
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cards   KanbanCard[]

  @@map("kanban_boards")
}

model KanbanCard {
  id        String   @id @default(cuid())
  boardId   String
  taskId    String
  columnId  String
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  board KanbanBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  task  Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([boardId, taskId])
  @@map("kanban_cards")
}

// AI Analysis Models
model AiAnalysis {
  id              String        @id @default(cuid())
  projectId       String?
  sessionId       String?
  analysisType    AnalysisType
  inputData       Json
  result          Json
  confidenceScore Float?
  status          AnalysisStatus @default(PENDING)
  errorMessage    String?
  createdBy       String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  project         Project?           @relation(fields: [projectId], references: [id])
  session         WorkshopSession?   @relation(fields: [sessionId], references: [id])
  requester       User               @relation("AnalysisRequester", fields: [createdBy], references: [id])
  recommendations AiRecommendation[]

  @@map("ai_analysis")
}

model AiRecommendation {
  id                     String               @id @default(cuid())
  analysisId             String
  projectId              String?
  type                   RecommendationType
  title                  String
  description            String
  impactScore            Int
  implementationEffort   ImplementationEffort
  status                 RecommendationStatus @default(PENDING)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  // Relations
  analysis AiAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  project  Project?   @relation(fields: [projectId], references: [id])

  @@map("ai_recommendations")
}

// File Upload Models
model FileUpload {
  id           String   @id @default(cuid())
  sessionId    String?
  taskId       String?
  originalName String
  fileName     String
  mimeType     String
  size         Int
  s3Key        String?
  s3Url        String?
  uploadedBy   String
  createdAt    DateTime @default(now())

  // Relations
  session  WorkshopSession? @relation(fields: [sessionId], references: [id])
  task     Task?            @relation(fields: [taskId], references: [id])
  uploader User             @relation(fields: [uploadedBy], references: [id])

  @@map("file_uploads")
}

// Communication Models
model Comment {
  id        String   @id @default(cuid())
  taskId    String
  content   String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id])

  @@map("comments")
}

// Activity Log Models
model ActivityLog {
  id        String       @id @default(cuid())
  sessionId String?
  userId    String
  action    ActivityType
  entityType String      // 'task', 'project', 'session', etc.
  entityId  String
  metadata  Json         @default("{}")
  createdAt DateTime     @default(now())

  // Relations
  session WorkshopSession? @relation(fields: [sessionId], references: [id])
  user    User             @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

// Enums
enum UserRole {
  TEAM_LEADER
  TEAM_MEMBER
  ADMIN
}

enum TeamMemberRole {
  LEADER
  MEMBER
}

enum SessionStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum TaskStatus {
  BACKLOG
  IN_PROGRESS
  REVIEW
  COMPLETED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AnalysisType {
  WORKFLOW_OPTIMIZATION
  RISK_ASSESSMENT
  RESOURCE_ALLOCATION
  TIMELINE_PREDICTION
  TASK_ANALYSIS
}

enum AnalysisStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum RecommendationType {
  PROCESS_IMPROVEMENT
  RESOURCE_OPTIMIZATION
  RISK_MITIGATION
  TIMELINE_ADJUSTMENT
  TASK_RESTRUCTURING
}

enum ImplementationEffort {
  LOW
  MEDIUM
  HIGH
}

enum RecommendationStatus {
  PENDING
  ACCEPTED
  REJECTED
  IMPLEMENTED
}

enum ActivityType {
  SESSION_CREATED
  SESSION_STARTED
  SESSION_COMPLETED
  DOMAIN_ADDED
  FILE_UPLOADED
  TASK_CREATED
  TASK_UPDATED
  TASK_MOVED
  TASK_COMPLETED
  AI_ANALYSIS_STARTED
  AI_ANALYSIS_COMPLETED
  RECOMMENDATION_GENERATED
}